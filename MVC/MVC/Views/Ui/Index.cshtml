<!-- No model. Next step is to implement Angular 2 against controller... -->


@{
    ViewBag.Title = "Index";
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Index</title>
</head>
<body>
    <div class="container">
        <div class="jumbotron">
            <div class="panel panel-default">
                <div id="head" class="panel-heading">

                    <div id="destinationElementApps">
                    </div>

                    <script id="templateApps" type="text/html">

                        {{#RootTagApps}}
                        <ul class="nav nav-tabs nav-justified">
                            <li id="app_{{Id}}"role="presentation"><a href="#{{Id}}">{{AppName}}</a></li>
                        </ul>
                        {{/RootTagApps}}

                    </script>
                    
                    <script id="templateAppsCategories" type="text/html">

                        {{#RootTagAppsCategories}}
                        <ul class="nav">
                            <li id="app_category_{{Id}}" role="presentation"><a href="#{{Id}}">{{Name}}</a></li>
                        </ul>
                        {{/RootTagAppsCategories}}

                    </script>

                </div>
                <div class="panel panel-body">
                    <div id="destinationElementAppsCategories">
                    </div>
                </div>
                <div id="templateAppsCategories" class="panel panel-body">
                            
                    Body!

                </div>
                <div id="foot" class="panel-footer">
                </div>
            </div>
        </div>
    </div>
</body>
</html>


@section scripts
{
    <script>

            // Intit data to runtime and localstorage
            $.get("http://localhost:44346/apps/GetAppsAsJson", function (data) {
                saveApps(data);
                saveAppsCategories();
                renderApps();
                addBtnEvent();
            });

            //State Start
            State =
            {
                Apps: [],
            };
            // End

            //App Constructor
            function App(app)
            {
                this.Id = app.Id;
                this.AppName = app.AppName;
                this.Categories = [];
                return this;
            }
            
            //Category Constructor
            function Category(category, places)
            {
                this.Id = category.Id;
                this.Name = category.Name;
                this.User = category.User;
                //places generated in ajax call.
                this.Places = places;
                return this;
            }

            //Place constructor
            function Place(place)
            {
                this.Id = place.Id;
                this.Name = place.Name;
                this.Address = place.Address;
                this.Longitude = place.Longitude;
                this.Latitude = place.Latitude;
                this.Description = place.Description;
                this.User = place.User;
            }

            //Apps Saved To Local Storage
            function saveApps(data)
            {
                localStorage.setItem("localStorageApps", data);
                var apps = JSON.parse(localStorage.getItem("localStorageApps"));

                //Iterate App Constructor
                $.each(apps, function (i, app) {
                    State.Apps.push(new App(app))
                })
            }
            // End

            
            //Apps -> Categories -> Places
            function saveAppsCategories()
            {
                $.each(State.Apps, function (i, app) {
                    SaveAppCategory(app);
                })
            }

            function SaveAppCategory(app) {
                $.get("http://localhost:44346/apps/GetCategoriesByAppAsJson/" + app.Id, function (data) {
                    var appCategories = JSON.parse(data);

                    //Iterate App Constructor
                    $.each(appCategories, function (i, category) {

                        $.get("http://localhost:44346/apps/GetPlacesByCategoryAsJson/" + category.Id, function (data) {
                            var categoryPlaces = JSON.parse(data);
                            var places = [];

                                $.each(categoryPlaces, function (i, place) {
                                places.push(new Place(place))        
                            })

                            app.Categories.push(new Category(category, places))
                        });

                    })
                });
            }
            // End

            // Render
            function renderApps(e){
                var templateWithData = Mustache.to_html($("#templateApps").html(), { RootTagApps: State.Apps });
                $("#destinationElementApps").empty().html(templateWithData);
            }

            //Add event to show somethig about app....
            function addBtnEvent() {
   
                $.each(State.Apps, function(i, app){


                    $("#app_" + app.Id).on('click', function (event) {
                        renderAppsCategories(app);
                        event.preventDefault;
                    })
                })
            }

            function renderAppsCategories(app) {
                console.log(app.Categories);
                var templateWithData = Mustache.to_html($("#templateAppsCategories").html(), { RootTagAppsCategories: app.Categories });
                $("#destinationElementAppsCategories").empty().html(templateWithData);
            }
            
    </script>

    <script src="~/Scripts/mustache.js"></script>

}


